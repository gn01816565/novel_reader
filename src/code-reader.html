<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>text_processor.php - MyBank</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
            overflow: hidden;
        }

        /* VS Code é ‚éƒ¨æ¨™ç±¤æ¬„ */
        .tab-bar {
            background-color: #2d2d2d;
            height: 35px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #1e1e1e;
        }

        .tab {
            background-color: #1e1e1e;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-right: 1px solid #2d2d2d;
            font-size: 13px;
        }

        .tab-icon {
            color: #519aba;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            background-color: #252526;
            padding: 10px;
            border-bottom: 1px solid #1e1e1e;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-panel button {
            background-color: #0e639c;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
        }

        .control-panel button:hover {
            background-color: #1177bb;
        }

        .control-panel textarea {
            flex: 1;
            background-color: #3c3c3c;
            color: #d4d4d4;
            border: 1px solid #3c3c3c;
            padding: 6px;
            font-family: inherit;
            font-size: 12px;
            resize: vertical;
            min-height: 60px;
        }

        .toggle-input {
            background-color: #37373d;
            font-size: 11px;
            padding: 4px 8px;
        }

        /* ç·¨è¼¯å™¨å®¹å™¨ */
        .editor-container {
            display: flex;
            height: calc(100vh - 35px - 61px);
        }

        /* è¡Œè™Ÿå€åŸŸ */
        .line-numbers {
            background-color: #1e1e1e;
            color: #858585;
            padding: 20px 10px;
            text-align: right;
            user-select: none;
            font-size: 14px;
            line-height: 1.6;
            min-width: 50px;
            border-right: 1px solid #1e1e1e;
        }

        /* ç¨‹å¼ç¢¼å€åŸŸ */
        .code-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
        }

        .code-line {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* èªæ³•é«˜äº® */
        .comment {
            color: #6a9955;
            font-style: italic;
        }

        .string {
            color: #ce9178;
        }

        .keyword {
            color: #569cd6;
        }

        .variable {
            color: #9cdcfe;
        }

        .function {
            color: #dcdcaa;
        }

        .operator {
            color: #d4d4d4;
        }

        .number {
            color: #b5cea8;
        }

        /* éš±è—è¼¸å…¥é¢æ¿ */
        .control-panel.hidden {
            display: none;
        }

        /* å¿«é€Ÿåˆ‡æ›æŒ‰éˆ• */
        .quick-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: #007acc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.3s;
            font-size: 16px;
            z-index: 1000;
        }

        .quick-toggle:hover {
            opacity: 1;
        }

        .tab-bar {
            cursor: pointer;
        }

        .tab-bar:hover {
            background-color: #2a2a2a;
        }

        /* ç« ç¯€å°èˆªæ¬„ */
        .chapter-nav {
            background-color: #252526;
            padding: 8px 15px;
            border-bottom: 1px solid #1e1e1e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .chapter-nav button {
            background-color: #0e639c;
            color: #fff;
            border: none;
            padding: 5px 15px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 11px;
        }

        .chapter-nav button:hover {
            background-color: #1177bb;
        }

        .chapter-nav button:disabled {
            background-color: #37373d;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .chapter-info {
            color: #858585;
            font-size: 11px;
        }

        .chapter-nav.hidden {
            display: none;
        }

        /* æ»¾å‹•æ¢æ¨£å¼ */
        .code-area::-webkit-scrollbar {
            width: 10px;
        }

        .code-area::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .code-area::-webkit-scrollbar-thumb {
            background: #424442;
        }

        .code-area::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }
    </style>
</head>
<body>
    <!-- VS Code æ¨™ç±¤æ¬„ (é›™æ“Šå¯åˆ‡æ›è¼¸å…¥æ¡†) -->
    <div class="tab-bar" ondblclick="toggleInput()" title="é›™æ“Šåˆ‡æ›è¼¸å…¥æ¡†">
        <div class="tab">
            <span class="tab-icon">âš™</span>
            <span>text_processor.php</span>
        </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel" id="controlPanel">
        <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
            <div style="display: flex; gap: 8px; font-size: 11px; color: #858585;">
                <span>ğŸ“– æ™ºèƒ½å°èˆªï¼šè²¼ä¸Šç¬¬ä¸€ç«  URL â†’ é»ã€Œåˆ†æä¸¦æŠ“å–ã€â†’ ä¹‹å¾Œå¯ç”¨ã€Œä¸Š/ä¸‹ä¸€ç« ã€æŒ‰éˆ•è‡ªå‹•æ›ç« </span>
            </div>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="currentUrl" placeholder="è²¼ä¸Šå°èªªç« ç¯€ URLï¼ˆä¾‹ï¼šhttps://m.biquge.tw/book/1281700/78890835.htmlï¼‰"
                       style="flex: 1; background-color: #3c3c3c; color: #d4d4d4; border: 1px solid #3c3c3c; padding: 6px; font-family: inherit; font-size: 12px;">
                <button onclick="analyzeAndFetch()" style="white-space: nowrap;">åˆ†æä¸¦æŠ“å–</button>
            </div>
            <textarea id="novelInput" placeholder="æˆ–ç›´æ¥è²¼ä¸Šå°èªªå…§å®¹..." style="min-height: 60px; width: 100%;"></textarea>
        </div>
        <div style="display: flex; flex-direction: column; gap: 8px;">
            <button onclick="convertToCode()">è½‰æ›</button>
            <button class="toggle-input" onclick="toggleInput()">éš±è—è¼¸å…¥æ¡†</button>
        </div>
    </div>

    <!-- ç« ç¯€å°èˆªæ¬„ -->
    <div class="chapter-nav" id="chapterNav">
        <button onclick="previousChapter()" id="prevBtn">â† ä¸Šä¸€ç« </button>
        <div style="display: flex; align-items: center; gap: 10px;">
            <select id="siteType" onchange="onSiteTypeChange()" style="background-color: #3c3c3c; color: #d4d4d4; border: 1px solid #555; padding: 4px 8px; font-size: 11px;">
                <option value="auto">ğŸ”„ è‡ªå‹•æª¢æ¸¬</option>
                <option value="biquge">ğŸ“š ç­†è¶£é–£ï¼ˆç°¡å–®å°èˆªï¼‰</option>
                <option value="wfxs">ğŸ“– äº”ç¦/å¾®é¢¨ï¼ˆåˆ†é +ç« ç¯€ï¼‰</option>
                <option value="other">ğŸŒ å…¶ä»–ç¶²ç«™</option>
            </select>
            <div class="chapter-info" id="chapterInfo">æº–å‚™å°±ç·’</div>
        </div>
        <button onclick="nextChapter()" id="nextBtn">ä¸‹ä¸€ç«  â†’</button>
    </div>

    <!-- ç·¨è¼¯å™¨å®¹å™¨ -->
    <div class="editor-container">
        <div class="line-numbers" id="lineNumbers">1</div>
        <div class="code-area" id="codeArea">
            <div class="code-line"><span class="comment">// Text Processing System v2.3</span></div>
            <div class="code-line"><span class="comment">// Author: Developer Team</span></div>
            <div class="code-line"><span class="comment">// Last modified: 2025-11-13</span></div>
        </div>
    </div>

    <!-- å¿«é€Ÿåˆ‡æ›æŒ‰éˆ• (å³ä¸‹è§’åŠé€æ˜åœ“é») -->
    <div class="quick-toggle" onclick="toggleInput()" title="é»æ“Šåˆ‡æ›è¼¸å…¥æ¡† (æˆ–æŒ‰ Ctrl+H / é›™æ“Šæ¨™é¡Œæ¬„)">âš™</div>

    <script>
        // å…¨åŸŸè®Šæ•¸ï¼šå„²å­˜ URL è¦å‰‡
        let urlPattern = null;
        let currentChapterInfo = null;

        // URL è¦å‰‡è§£æå™¨
        const urlPatterns = {
            // ç­†è¶£é–£æ‰‹æ©Ÿç‰ˆï¼šhttps://m.biquge.tw/book/1281700/78890835.html
            biquge_mobile: {
                pattern: /^(https?:\/\/m\.biquge\.[^\/\?]+)\/book\/(\d+)\/(\d+)\.html/i,
                template: '{domain}/book/{bookId}/{chapterId}.html',
                extract: (url) => {
                    // ç§»é™¤å¯èƒ½çš„æŸ¥è©¢åƒæ•¸
                    url = url.split('?')[0].split('#')[0];
                    const match = url.match(/^(https?:\/\/m\.biquge\.[^\/]+)\/book\/(\d+)\/(\d+)\.html/i);
                    if (match) {
                        console.log('ç­†è¶£é–£æ‰‹æ©Ÿç‰ˆåŒ¹é…æˆåŠŸ:', match);
                        return {
                            domain: match[1],
                            bookId: match[2],
                            chapterId: parseInt(match[3]),
                            chapterIdType: 'number'
                        };
                    }
                    return null;
                }
            },
            // ç­†è¶£é–£PCç‰ˆï¼šhttps://www.biquge.tw/book/1281700/78890835.html
            biquge_pc: {
                pattern: /^(https?:\/\/www\.biquge\.[^\/\?]+)\/book\/(\d+)\/(\d+)\.html/i,
                template: '{domain}/book/{bookId}/{chapterId}.html',
                extract: (url) => {
                    url = url.split('?')[0].split('#')[0];
                    const match = url.match(/^(https?:\/\/www\.biquge\.[^\/]+)\/book\/(\d+)\/(\d+)\.html/i);
                    if (match) {
                        console.log('ç­†è¶£é–£PCç‰ˆåŒ¹é…æˆåŠŸ:', match);
                        return {
                            domain: match[1],
                            bookId: match[2],
                            chapterId: parseInt(match[3]),
                            chapterIdType: 'number'
                        };
                    }
                    return null;
                }
            },
            // é€šç”¨ç­†è¶£é–£æ ¼å¼ï¼ˆåŒ…å«å„ç¨®åŸŸåè®Šé«”ï¼‰
            biquge_generic: {
                pattern: /^(https?:\/\/[^\/]*biquge[^\/]*)\/book\/(\d+)\/(\d+)\.html/i,
                template: '{domain}/book/{bookId}/{chapterId}.html',
                extract: (url) => {
                    url = url.split('?')[0].split('#')[0];
                    const match = url.match(/^(https?:\/\/[^\/]*biquge[^\/]*)\/book\/(\d+)\/(\d+)\.html/i);
                    if (match) {
                        console.log('é€šç”¨ç­†è¶£é–£æ ¼å¼åŒ¹é…æˆåŠŸ:', match);
                        return {
                            domain: match[1],
                            bookId: match[2],
                            chapterId: parseInt(match[3]),
                            chapterIdType: 'number'
                        };
                    }
                    return null;
                }
            },
            // äº”ç¦å°èªªç¶²ï¼šhttps://m.wfxs.tw/xs-2075761/du-152156760/2.html
            wfxs: {
                pattern: /^(https?:\/\/[^\/]*wfxs\.[^\/]+)\/xs-(\d+)\/du-(\d+)\/(\d+)\.html/i,
                template: '{domain}/xs-{bookId}/du-{volumeId}/{chapterId}.html',
                extract: (url) => {
                    url = url.split('?')[0].split('#')[0];
                    const match = url.match(/^(https?:\/\/[^\/]*wfxs\.[^\/]+)\/xs-(\d+)\/du-(\d+)\/(\d+)\.html/i);
                    if (match) {
                        console.log('äº”ç¦å°èªªç¶²åŒ¹é…æˆåŠŸ:', match);
                        return {
                            domain: match[1],
                            bookId: match[2],
                            volumeId: match[3],
                            chapterId: parseInt(match[4]),
                            chapterIdType: 'number'
                        };
                    }
                    return null;
                }
            },
        };

        // åˆ†æ URL çµæ§‹
        function analyzeUrl(url) {
            for (const [name, pattern] of Object.entries(urlPatterns)) {
                const info = pattern.extract(url);
                if (info) {
                    info.patternName = name;
                    info.template = pattern.template;
                    return info;
                }
            }
            return null;
        }

        // æ ¹æ“šè¦å‰‡ç”Ÿæˆæ–°çš„ URL
        function generateUrl(info, offset) {
            if (!info || info.chapterIdType !== 'number') return null;

            const newChapterId = info.chapterId + offset;
            let newUrl = info.template
                .replace('{domain}', info.domain)
                .replace('{bookId}', info.bookId)
                .replace('{chapterId}', newChapterId);

            // å¦‚æœæœ‰ volumeIdï¼ˆä¾‹å¦‚äº”ç¦å°èªªç¶²ï¼‰
            if (info.volumeId) {
                newUrl = newUrl.replace('{volumeId}', info.volumeId);
            }

            return newUrl;
        }

        // å‡ç¨‹å¼ç¢¼æ¨¡æ¿
        const fakeCodeTemplates = [
            '<span class="keyword">function</span> <span class="function">processText</span>(<span class="variable">$content</span>) {',
            '    <span class="keyword">return</span> <span class="function">trim</span>(<span class="variable">$content</span>);',
            '}',
            '',
            '<span class="keyword">class</span> <span class="function">TextHandler</span> {',
            '    <span class="keyword">private</span> <span class="variable">$data</span>;',
            '    ',
            '    <span class="keyword">public function</span> <span class="function">__construct</span>() {',
            '        <span class="variable">$this</span>-><span class="variable">data</span> = [];',
            '    }',
            '}',
            '',
            '<span class="keyword">if</span> (<span class="variable">$result</span> !== <span class="keyword">null</span>) {',
            '    <span class="comment">// Process valid data</span>',
            '}',
            '',
            '<span class="variable">$config</span> = [',
            '    <span class="string">\'encoding\'</span> => <span class="string">\'UTF-8\'</span>,',
            '    <span class="string">\'mode\'</span> => <span class="string">\'strict\'</span>',
            '];',
        ];

        // åˆ†æ URL ä¸¦æŠ“å–å…§å®¹
        async function analyzeAndFetch() {
            let url = document.getElementById('currentUrl').value.trim();

            if (!url) {
                updateChapterInfo('è«‹è¼¸å…¥ç« ç¯€ URL');
                return;
            }

            console.log('æº–å‚™åˆ†æ URL:', url);

            // è‡ªå‹•è£œå……ä¸å®Œæ•´çš„äº”ç¦å°èªªç¶² URL
            const wfxsIncomplete = url.match(/^(https?:\/\/[^\/]*wfxs\.[^\/]+\/xs-\d+\/du-\d+)\/?$/i);
            if (wfxsIncomplete) {
                url = wfxsIncomplete[1] + '/1.html';
                console.log('è‡ªå‹•è£œå……äº”ç¦å°èªªç¶² URL ç‚º:', url);
                document.getElementById('currentUrl').value = url;
                updateChapterInfo('å·²è‡ªå‹•è£œå……ç‚ºç¬¬ 1 ç« ');
            }

            // åˆ†æ URL çµæ§‹
            const info = analyzeUrl(url);
            if (!info) {
                updateChapterInfo('ç„¡æ³•è­˜åˆ¥æ­¤ç¶²ç«™çš„ URL æ ¼å¼');
                console.error('URL ç„¡æ³•åŒ¹é…ä»»ä½•å·²çŸ¥è¦å‰‡');
                console.log('è«‹æª¢æŸ¥ URL æ ¼å¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–æ‰‹å‹•è²¼ä¸Šå…§å®¹');

                // é¡¯ç¤ºåœ¨é é¢ä¸Š
                alert('ç„¡æ³•è­˜åˆ¥æ­¤ç¶²ç«™çš„ URL æ ¼å¼\n\n' +
                      'æ‚¨è¼¸å…¥çš„ URLï¼š' + url + '\n\n' +
                      'ç›®å‰æ”¯æ´çš„ç¶²ç«™ï¼š\n' +
                      '- ç­†è¶£é–£ï¼šhttps://m.biquge.tw/book/æ•¸å­—/æ•¸å­—.html\n' +
                      '- ç­†è¶£é–£ï¼šhttps://www.biquge.tw/book/æ•¸å­—/æ•¸å­—.html\n' +
                      '- äº”ç¦å°èªªç¶²ï¼šhttps://m.wfxs.tw/xs-æ•¸å­—/du-æ•¸å­—/æ•¸å­—.html\n\n' +
                      'æ‚¨å¯ä»¥ï¼š\n' +
                      '1. æª¢æŸ¥ URL æ ¼å¼æ˜¯å¦æ­£ç¢º\n' +
                      '2. æˆ–ç›´æ¥è¤‡è£½ç¶²é å…§å®¹è²¼åˆ°ä¸‹æ–¹æ–‡å­—æ¡†\n' +
                      '3. æä¾› URL çµ¦æˆ‘ï¼Œæˆ‘å¯ä»¥æ·»åŠ æ”¯æ´');
                return;
            }

            console.log('URL åˆ†æçµæœ:', info);
            currentChapterInfo = info;

            // æ›´æ–°æç¤º
            updateChapterInfo(`å·²è­˜åˆ¥ï¼š${info.patternName} | ç« ç¯€ ${info.chapterId}`);

            // é–‹å§‹æŠ“å–
            await fetchChapter(url);
        }

        // æŠ“å–æŒ‡å®šç« ç¯€
        async function fetchChapter(url, isAutoNext = false) {
            const novelInput = document.getElementById('novelInput');
            const chapterInfo = document.getElementById('chapterInfo');

            // ç«‹å³æ›´æ–° URL è¼¸å…¥æ¡†ï¼Œé¡¯ç¤ºæ­£åœ¨æŠ“å–çš„é é¢
            document.getElementById('currentUrl').value = url;

            updateChapterInfo('æ­£åœ¨æŠ“å–...');
            novelInput.value = 'æ­£åœ¨æŠ“å–ç¶²é å…§å®¹ï¼Œè«‹ç¨å€™...';
            novelInput.disabled = true;

            try {
                const response = await fetch('fetch_novel.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'url=' + encodeURIComponent(url)
                });

                const result = await response.json();
                console.log('æŠ“å–çµæœ:', result);

                if (result.success && result.content && result.content.trim().length > 500) {
                    novelInput.value = result.content;
                    novelInput.disabled = false;

                    // è‡ªå‹•è½‰æ›
                    convertToCode();

                    // è‡ªå‹•æ²å‹•åˆ°æœ€ä¸Šæ–¹
                    document.getElementById('codeArea').scrollTop = 0;
                    window.scrollTo(0, 0);

                    // æ›´æ–°ç« ç¯€è³‡è¨Š
                    if (currentChapterInfo) {
                        updateChapterInfo(`ç« ç¯€ ${currentChapterInfo.chapterId} | ${result.content.length} å­—`);
                        // å„²å­˜ç•¶å‰ URL
                        document.getElementById('currentUrl').value = url;
                        localStorage.setItem('currentChapterUrl', url);
                        localStorage.setItem('currentChapterInfo', JSON.stringify(currentChapterInfo));
                    }
                    return true; // æˆåŠŸæŠ“å–
                } else {
                    // å…§å®¹ç‚ºç©ºæˆ–å¤ªçŸ­ï¼Œå¯èƒ½æ˜¯æœ€å¾Œä¸€é 
                    if (isAutoNext) {
                        console.log('å…§å®¹ç‚ºç©ºæˆ–å¤ªçŸ­ï¼Œå¯èƒ½å·²åˆ°æœ€å¾Œä¸€é ');
                        return false; // æŠ“å–å¤±æ•—
                    }
                    novelInput.value = '';
                    novelInput.disabled = false;
                    updateChapterInfo('æŠ“å–å¤±æ•—ï¼šå…§å®¹ç‚ºç©ºæˆ–å¤ªçŸ­');
                    return false;
                }
            } catch (error) {
                console.error('æŠ“å–éŒ¯èª¤:', error);
                if (!isAutoNext) {
                    novelInput.value = '';
                    novelInput.disabled = false;
                    updateChapterInfo('æŠ“å–å¤±æ•—ï¼š' + error.message);
                }
                return false;
            }
        }

        // ä¸Šä¸€ç« 
        async function previousChapter() {
            if (!currentChapterInfo) {
                updateChapterInfo('è«‹å…ˆåˆ†æä¸€å€‹ç« ç¯€ URL');
                return;
            }

            const prevUrl = generateUrl(currentChapterInfo, -1);
            if (!prevUrl) {
                updateChapterInfo('ç„¡æ³•ç”Ÿæˆä¸Šä¸€ç«  URL');
                return;
            }

            console.log('ä¸Šä¸€ç«  URL:', prevUrl);
            currentChapterInfo.chapterId--;
            await fetchChapter(prevUrl);
        }

        // ä¸‹ä¸€ç« ï¼ˆæ™ºèƒ½åˆ†é ï¼‰
        async function nextChapter() {
            if (!currentChapterInfo) {
                updateChapterInfo('è«‹å…ˆåˆ†æä¸€å€‹ç« ç¯€ URL');
                return;
            }

            // å…ˆå˜—è©¦ç•¶å‰ç« ç¯€çš„ä¸‹ä¸€é 
            const nextPageUrl = generateUrl(currentChapterInfo, 1);
            if (!nextPageUrl) {
                updateChapterInfo('ç„¡æ³•ç”Ÿæˆä¸‹ä¸€ç«  URL');
                return;
            }

            console.log('å˜—è©¦ä¸‹ä¸€é  URL:', nextPageUrl);
            currentChapterInfo.chapterId++;

            const success = await fetchChapter(nextPageUrl, true);

            if (!success && currentChapterInfo.volumeId) {
                // å¦‚æœæ˜¯äº”ç¦å°èªªç¶²ä¸”ç•¶å‰é æ²’æœ‰å…§å®¹ï¼Œå˜—è©¦ä¸‹ä¸€å€‹ç« ç¯€
                console.log('ç•¶å‰åˆ†é å·²çµæŸï¼Œå˜—è©¦ä¸‹ä¸€ç« ç¯€...');
                currentChapterInfo.volumeId++;
                currentChapterInfo.chapterId = 1;

                const nextVolumeUrl = generateUrl(currentChapterInfo, 0);
                if (nextVolumeUrl) {
                    console.log('è·³è½‰åˆ°ä¸‹ä¸€ç« ç¯€:', nextVolumeUrl);
                    updateChapterInfo('è‡ªå‹•è·³è½‰åˆ°ä¸‹ä¸€ç« ç¯€...');
                    await fetchChapter(nextVolumeUrl);
                } else {
                    updateChapterInfo('ç„¡æ³•ç”Ÿæˆä¸‹ä¸€ç« ç¯€ URL');
                    // æ¢å¾©åŸå§‹ç‹€æ…‹
                    currentChapterInfo.volumeId--;
                    currentChapterInfo.chapterId--;
                }
            } else if (!success) {
                // éäº”ç¦å°èªªç¶²æˆ–å…¶ä»–éŒ¯èª¤
                currentChapterInfo.chapterId--;
                updateChapterInfo('å·²åˆ°æœ€å¾Œä¸€ç« æˆ–æŠ“å–å¤±æ•—');
            }
        }

        // æ›´æ–°ç« ç¯€è³‡è¨Šé¡¯ç¤º
        function updateChapterInfo(text) {
            document.getElementById('chapterInfo').textContent = text;
        }

        // å¾ URL æŠ“å–å…§å®¹ï¼ˆä¿ç•™èˆŠåŠŸèƒ½ï¼‰
        async function fetchFromUrl() {
            const urlInput = document.getElementById('currentUrl');
            const url = urlInput.value.trim();

            if (!url) {
                alert('è«‹è¼¸å…¥ç¶²é  URLï¼');
                return;
            }

            console.log('æº–å‚™æŠ“å– URL:', url);

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            const novelInput = document.getElementById('novelInput');
            novelInput.value = 'æ­£åœ¨æŠ“å–ç¶²é å…§å®¹ï¼Œè«‹ç¨å€™...';
            novelInput.disabled = true;

            try {
                const response = await fetch('fetch_novel.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'url=' + encodeURIComponent(url)
                });

                const result = await response.json();
                console.log('æŠ“å–çµæœ:', result);

                if (result.success) {
                    novelInput.value = result.content;
                    novelInput.disabled = false;
                    alert('æŠ“å–æˆåŠŸï¼å…± ' + result.content.length + ' å­—ï¼Œé»æ“Šã€Œè½‰æ›ã€æŒ‰éˆ•ç¹¼çºŒ');
                } else {
                    novelInput.value = '';
                    novelInput.disabled = false;
                    alert('æŠ“å–å¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                console.error('æŠ“å–éŒ¯èª¤:', error);
                novelInput.value = '';
                novelInput.disabled = false;
                alert('æŠ“å–å¤±æ•—ï¼š' + error.message);
            }
        }

        // è½‰æ›å°èªªå…§å®¹ç‚ºç¨‹å¼ç¢¼æ ¼å¼
        function convertToCode() {
            console.log('è½‰æ›å‡½æ•¸è¢«èª¿ç”¨');
            const input = document.getElementById('novelInput').value;
            console.log('è¼¸å…¥å…§å®¹é•·åº¦:', input.length);

            if (!input.trim()) {
                alert('è«‹å…ˆè¼¸å…¥å°èªªå…§å®¹æˆ–å¾ URL æŠ“å–ï¼');
                console.log('è¼¸å…¥ç‚ºç©º');
                return;
            }

            console.log('é–‹å§‹è½‰æ›...');

            // åˆ†å‰²æ®µè½
            const paragraphs = input.split(/\n+/).filter(p => p.trim());
            const codeLines = [];
            let lineNumber = 1;

            // æ·»åŠ æª”æ¡ˆæ¨™é ­
            codeLines.push('<span class="comment">/**</span>');
            codeLines.push('<span class="comment"> * Text Content Processing Module</span>');
            codeLines.push('<span class="comment"> * Generated: ' + new Date().toLocaleString('zh-TW') + '</span>');
            codeLines.push('<span class="comment"> */</span>');
            codeLines.push('');

            // éš¨æ©Ÿæ’å…¥å‡ç¨‹å¼ç¢¼
            const insertFakeCode = () => {
                const numLines = Math.floor(Math.random() * 3) + 1;
                for (let i = 0; i < numLines; i++) {
                    const template = fakeCodeTemplates[Math.floor(Math.random() * fakeCodeTemplates.length)];
                    codeLines.push(template);
                }
                codeLines.push('');
            };

            // è™•ç†æ¯å€‹æ®µè½
            paragraphs.forEach((para, index) => {
                // æ¯éš”å¹¾æ®µæ’å…¥å‡ç¨‹å¼ç¢¼
                if (index > 0 && index % 3 === 0) {
                    insertFakeCode();
                }

                // å°‡æ®µè½åˆ†æˆå¥å­
                const sentences = para.match(/[^ã€‚ï¼ï¼Ÿ.!?]+[ã€‚ï¼ï¼Ÿ.!?]*/g) || [para];

                sentences.forEach((sentence, sentIndex) => {
                    const formatType = Math.random();

                    if (formatType < 0.4) {
                        // å–®è¡Œè¨»è§£æ ¼å¼
                        codeLines.push(`<span class="comment">// ${escapeHtml(sentence)}</span>`);
                    } else if (formatType < 0.7) {
                        // å­—ä¸²è®Šæ•¸æ ¼å¼
                        const varName = ['$text', '$content', '$message', '$data', '$info'][Math.floor(Math.random() * 5)];
                        codeLines.push(`<span class="variable">${varName}</span> = <span class="string">"${escapeHtml(sentence)}"</span>;`);
                    } else {
                        // å¤šè¡Œè¨»è§£æ ¼å¼
                        codeLines.push(`<span class="comment">/* ${escapeHtml(sentence)} */</span>`);
                    }
                });

                codeLines.push('');
            });

            // çµå°¾åŠ å…¥å‡ç¨‹å¼ç¢¼
            insertFakeCode();

            // æ¸²æŸ“åˆ°é é¢
            renderCode(codeLines);

            // å„²å­˜åˆ° localStorage
            localStorage.setItem('novelContent', input);
            console.log('è½‰æ›å®Œæˆï¼ç¸½å…±', codeLines.length, 'è¡Œ');

            // è‡ªå‹•éš±è—è¼¸å…¥æ¡†
            setTimeout(() => {
                if (!document.getElementById('controlPanel').classList.contains('hidden')) {
                    toggleInput();
                }
            }, 500);
        }

        // å„²å­˜æ›¸ç±¤
        function saveBookmark() {
            const url = document.getElementById('currentUrl').value.trim();
            if (url) {
                localStorage.setItem('bookmarkUrl', url);
                console.log('æ›¸ç±¤å·²å„²å­˜:', url);
            }
        }

        // æ¸²æŸ“ç¨‹å¼ç¢¼å’Œè¡Œè™Ÿ
        function renderCode(codeLines) {
            console.log('é–‹å§‹æ¸²æŸ“ç¨‹å¼ç¢¼...');
            const codeArea = document.getElementById('codeArea');
            const lineNumbers = document.getElementById('lineNumbers');

            // ç”Ÿæˆç¨‹å¼ç¢¼å…§å®¹
            codeArea.innerHTML = codeLines
                .map(line => `<div class="code-line">${line || '&nbsp;'}</div>`)
                .join('');

            // ç”Ÿæˆè¡Œè™Ÿ
            lineNumbers.innerHTML = codeLines
                .map((_, index) => index + 1)
                .join('<br>');
        }

        // HTML è·³è„«
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // åˆ‡æ›è¼¸å…¥é¢æ¿é¡¯ç¤º
        function toggleInput() {
            const panel = document.getElementById('controlPanel');
            panel.classList.toggle('hidden');

            // èª¿æ•´ç·¨è¼¯å™¨é«˜åº¦
            const editor = document.querySelector('.editor-container');
            if (panel.classList.contains('hidden')) {
                editor.style.height = 'calc(100vh - 35px)';
            } else {
                editor.style.height = 'calc(100vh - 35px - 61px)';
            }
        }

        // é é¢è¼‰å…¥æ™‚æ¢å¾©ä¸Šæ¬¡çš„å…§å®¹
        window.addEventListener('DOMContentLoaded', () => {
            // æ¢å¾©ä¸Šæ¬¡çš„ç« ç¯€è³‡è¨Š
            const savedUrl = localStorage.getItem('currentChapterUrl');
            const savedInfo = localStorage.getItem('currentChapterInfo');

            if (savedUrl && savedInfo) {
                document.getElementById('currentUrl').value = savedUrl;
                currentChapterInfo = JSON.parse(savedInfo);
                updateChapterInfo(`ä¸Šæ¬¡ï¼šç« ç¯€ ${currentChapterInfo.chapterId}`);
            }

            // æ¢å¾©ä¸Šæ¬¡çš„å°èªªå…§å®¹
            const saved = localStorage.getItem('novelContent');
            if (saved) {
                document.getElementById('novelInput').value = saved;
                convertToCode();
            }
        });

        // å¿«æ·éµï¼šCtrl + H åˆ‡æ›è¼¸å…¥æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'h') {
                e.preventDefault();
                toggleInput();
            }
        });
    </script>
</body>
</html>
